<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <title>You draw, I guess</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8"/>
    <meta content="yes" name="apple-mobile-web-app-capable"/>
    <meta content="yes" name="apple-touch-fullscreen"/>
    <meta content="telephone=no" name="format-detection"/>
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="#ffffff" name="msapplication-TileColor"/>
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="Cache-Control" content="no-store">
    <meta http-equiv="Pragma" content="no-cache">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/pixi-4.3.5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            text-align: center;
            vertical-align: middle;
        }

        html, body {
        }

        body {
            background-color: #eeeeee;
            font-size: 14px;
            color: #5d656b;
        }

        a, button, input {
            outline: 0 none;
            text-decoration: none;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        input {
            box-sizing: border-box;
        }

        .head-content {
            position: relative;
            left: 0;
            top: 0;
            width: 100%;
            display: block;
            height: 44px;
            line-height: 44px;
            background-color: #dddddd;
        }

        .body-content {
            width: 100%;
            text-align: center;
        }

        .center-content, .message-layout, .canvas-layout {
            top: 0;
            left: 0;
            height: 600px;
        }

        .center-content {
            position: relative;
            margin: 0 auto;
            max-width: 640px;
            min-width: 320px;
        }

        .message-layout {
            position: relative;
            display: block;
            width: 100%;
            overflow-y: scroll;
        }

        .canvas-layout {
            position: absolute;
            width: 100%;
        }

        .message-layout div {
            text-align: left;
            margin: 5px 110px;
        }
    </style>
</head>

<body>
<div class="body-content">
    <div class="head-content">
        <!-- <a href="mregist1.html"><span class="kt-icons">&#xf0c7;</span></a> -->
        <h2>Spring mvc & Undertow</h2>
    </div>
    <div class="center-content">
        <div class="message-layout"></div>
        <div class="canvas-layout" game='lrs-replay' game-data="lrsReplayData1">

        </div>
    </div>
</div>

<script>
    (function(){

        let $ = jQuery;

        /**
         * 非绑定给节点的方法，写在 $.extend 内
         */
        $.extend({

            /**
             * a AJax request
             */
            KTAjax: function(url, method, data, headers, success, error, complete) {
                // stop before one ajax request
                if (typeof(window.currentKTAjax)==="object") {
                    try{window.currentKTAjax.abort()}catch(e){}
                }
                // set headers
                if ($.type(headers)!=="object" || $.isEmptyObject(headers)) {
                    headers = {};
                }
                headers['access-token'] = "";
                // set content type
                let contentType = (method.toLowerCase()==="post" && !(data instanceof FormData)) ? "application/x-www-form-urlencoded; charset=UTF-8" : false;
                // set ajax request
                window.currentKTAjax = $.ajax({
                    "url"  : url,
                    "type" : method,
                    "data" : data,
                    "contentType" : contentType,
                    "processData" : false,
                    "headers" : headers,
                    "success" : function(responseText) {
                        if ($.isFunction(success)) success(responseText);
                    },
                    "error" : function(XMLHttpRequest) {
                        if ($.isFunction(error)) error(XMLHttpRequest);
                    },
                    "complete" : function(XMLHttpRequest) {
                        if ($.isFunction(complete)) complete(XMLHttpRequest);
                    }
                });
            },

            /*
             *
             */
            KTAnchor: {
                // Ajax 正常返回
                success : function(container, responseText) {
                    if (typeof(responseText)==="object" && responseText.action!==null) {

                    }
                    // 填充完后重新设定填充区域内的 KTLoader
                    $(container).KTLoader();
                },
                // Ajax 错误
                error: function(container, XMLHttpRequest) {

                },
                // Ajax 处理完成
                complete: function(container, XMLHttpRequest) {

                }
            }
        });

        /**
         * 绑定给节点的方法，写在 $.fn.extend 内
         */
        $.fn.extend({

            getHexBackgroundColor : function() {
                let rgb = $(this).css('background-color');
                let pattern = /^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/;
                if(pattern.test(rgb)) {
                    let _match = rgb.match(pattern);
                    let _hex = function(x) {
                        return ("0" + parseInt(x).toString(16)).slice(-2);
                    };
                    rgb= "#" + _hex(_match[1]) + _hex(_match[2]) + _hex(_match[3]);
                }
                return rgb.substr(1);
            },

            KTAnchor : function(success, error, begin, complete) {
                // 取得 某文档下 所有没有被标注为原生的 anchor
                this.find("a").each(function(key, anchor){
                    // jQuery 对象
                    let $anchor = $(anchor);
                    // 给 <a native 标记不绑 ajax 请求
                    if (typeof($anchor.attr('native'))!=="undefined") {
                        // 这个点归点，别冒泡，可能的多次遍历到时，只处理一次
                        if ($anchor.data("native-click")===null) {
                            // 不冒泡
                            $anchor.bind("click", function(e){
                                e.stopPropagation();
                            });
                            // 标记
                            $anchor.data("native-click", "native-click");
                        }
                        return;
                    }
                    // 如果是 <a href="javascript:..." 也是不能去绑定
                    if (/^javascript:/.test($anchor.attr("href"))) return;
                    // 如果是 # 也是不能绑定
                    if ($anchor.attr("href")==="#") return;
                    // 如果已经绑定过
                    if ($anchor.data("ajax-click")!==null) return;

                    // 绑定点击事件
                    $anchor.on("click", function() {
                        // 如果有 confirm 属性
                        if (typeof($anchor.attr("confirm"))!=="undefined" && $anchor.attr("confirm").length>1 && $anchor.data("confirm-click")===null) {
                            $.confirm($anchor.attr("confirm"), function(){
                                $anchor.data("confirm-click", "confirm-click");
                                $anchor.trigger("click");
                            });
                        }
                        // 聚焦会使得点击处框上虚线
                        $anchor.context.blur();
                        // 获取要请求的地址
                        let requestUrl = $anchor.attr("href");
                        // 获取当前的地址
                        // let currentRef = window.location.href;
                        // 如果设置了 <a unpushstate ..> 那么不做 url pushState
                        if (typeof($anchor.attr("unpushstate"))==="undefined") {
                            window.history.pushState(null, "", requestUrl);
                        }
                        // 返回的内容填充到哪
                        let container = $.KTAnchor.response_container;
                        if (typeof($anchor.attr("container"))!=="undefined" && $anchor.attr("container").length>1) {
                            container = $anchor.attr("container");
                        }
                        // set header
                        let header = null;
                        if ($.type($anchor.attr("header"))==="string") {
                            header = $.parseJSON($anchor.attr("header"));
                        }
                        // ajax 请求，并回调
                        $.KTAjax(requestUrl, "GET", null, header,
                            // 成功
                            function(responseText){
                                $.isFunction(success) ? success(container, responseText) : $.KTAjax.success(container, responseText);
                            },
                            // 错误
                            function(XMLHttpRequest){
                                $.isFunction(error) ? error(container, XMLHttpRequest) : $.KTAjax.error(container, XMLHttpRequest);
                            },
                            // 结束 ( 成功或失败后 )
                            function(XMLHttpRequest){
                                $.isFunction(complete) ? complete(container, XMLHttpRequest) : $.KTAjax.complete(container, XMLHttpRequest);
                            }
                        );
                        // data 的 confirm-click 值重置
                        $anchor.data("confirm-click", null);
                        // 防止链接点击生效
                        return false;
                    });
                });
                // 返回 JQuery 对象
                return this;
            },

            LrsReplayTagScan: function() {
                // 取得 某文档下 所有没有被标注为原生的 anchor
                this.find("div[game='lrs-replay']").each(function(key, _replayBox) {
                    // 获取在哪个节点播放这个
                    let replayBox = $(_replayBox);
                    let replayDataKey = replayBox.attr("game-data");
                    let replayData = window[replayDataKey];
                    let messageBox = replayBox.prev()[0];
                    // 开始一个新游戏
                    new OneLRSGame({
                        "messageBox" : messageBox,
                        "replayBox" : replayBox,
                        "width" : replayBox.width(),
                        "height" : replayBox.height(),
                        "backgroundColor" : replayBox.getHexBackgroundColor(),
                        "playerList" : replayData.playerList,
                        "playData" : replayData.playData
                    });
                });
            },

            KTLoader: function() {
                this.KTAnchor().LrsReplayTagScan();
            }
        });

    })(jQuery);


    // 文档加载完开始
    $(document).ready(function(){
        $(document.body).KTLoader();
    });


    /*
     * 一局
     */
    function OneLRSGame(config) {

        console.log(config);

        this.messageBox = config.messageBox;

        this.replayBox = config.replayBox;

        this.width = config.width;

        this.height = config.height;

        this.backgroundColor = config.backgroundColor;

        this.playData = config.playData;

        this.players = [];

        // this.pixiApp = new PIXI.Application(this.width, this.height, {backgroundColor : "0x" + this.backgroundColor});
        this.pixiApp = new PIXI.Application(this.width, this.height, {transparent:true});

        this.replayBox.prepend(this.pixiApp.view);

        this.init();

//        let instantic = this;
//        setTimeout(function(){
//            instantic.loopPlay(instantic.playData, 0);
//        }, 500);
    }

    OneLRSGame.prototype.init = function() {
    };


</script>

</body>
</html>